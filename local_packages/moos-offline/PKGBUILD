pkgname='moos-offline'
pkgver=20250808
pkgrel=1
pkgdesc='Setup MOOS for extended use without an internet connection.'
arch=('any')
options=('!debug')
depends=(
    # Base packages.
    'moos'

    # Browse websites offline.
    'kiwix-tools'
)
source=(
)
sha256sums=(
)
_kiwix_url='https://mirror.download.kiwix.org/zim/'
_kiwix_books=(
    'other/archlinux_en_all_maxi'
    'zimit/anonymousplanet.org_en_all'
    # 'gutenberg/gutenberg_en_all'
)

package() {
    _kiwix_dir="$pkgdir/usr/share/kiwix/"
    _kiwix_zim_dir="${_kiwix_dir}zim/"
    install -dm755 "$_kiwix_zim_dir"

    for _book in "${_kiwix_books}"
    do
        _book_section="${_book%%/*}"
        _book_name="${_book#*/}"
        echo "$_book_name"
        _kiwix_section_url="$_kiwix_url$_book_section/"
        _book_name_full=$(curl -s "$_kiwix_section_url" | grep -oP "${_book_name}_\d{4}-\d{2}\.zim" | sort -V | tail -n 1)
        _kiwix_book_url="$_kiwix_section_url$_book_name_full"
        curl "$_kiwix_book_url" -o "$_kiwix_zim_dir$_book_name_full"
    done

    kiwix-manage "${_kiwix_dir}library.xml" add "${_kiwix_zim_dir}*.zim"
}
