pkgname='moos-offline'
pkgver=20250808
pkgrel=1
pkgdesc='Setup MOOS for extended use without an internet connection.'
arch=('any')
options=('!debug')
depends=(
    # Base packages.
    'moos'

    # Browse websites offline.
    'kiwix-tools'
)
source=(
)
sha256sums=(
)
_kiwix_url='https://mirror.download.kiwix.org/zim/'
_kiwix_books=(
    'other/archlinux_en_all_maxi'
    'zimit/anonymousplanet.org_en_all'
    # 'gutenberg/gutenberg_en_all'
)
_service_name='serve-kiwix'

_kiwix_serve_service() {
    echo '[Unit]'
    echo 'Description=Serve books with Kiwix'
    echo 'After=network-online.target'
    echo ''
    echo '[Service]'
    echo 'Type=exec'
    echo 'ExecStart=/usr/bin/kiwix-serve --library /usr/share/kiwix/library.xml'
    echo ''
    echo '[Install]'
    echo 'WantedBy=multi-user.target'
}

package() {
    _kiwix_dir="$pkgdir/usr/share/kiwix/"
    _kiwix_zim_dir="${_kiwix_dir}zim/"
    install -dm755 "$_kiwix_zim_dir"

    for _book in "${_kiwix_books[@]}"
    do
        _book_section="${_book%%/*}"
        _book_name="${_book#*/}"
        echo "$_book_name"
        _kiwix_section_url="$_kiwix_url$_book_section/"
        _book_name_full=$(curl -s "$_kiwix_section_url" | grep -oP "${_book_name}_\d{4}-\d{2}\.zim" | sort -V | tail -n 1)
        _kiwix_book_url="$_kiwix_section_url$_book_name_full"
        curl "$_kiwix_book_url" -o "$_kiwix_zim_dir$_book_name_full"
    done

    kiwix-manage "${_kiwix_dir}library.xml" add ${_kiwix_zim_dir}*.zim

    _kiwix_serve_service > "$_service_name.service"
    install -Dm644 "$_service_name.service" "$pkgdir/usr/lib/systemd/system/$_service_name.service"
}
